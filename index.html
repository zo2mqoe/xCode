// [สำคัญ!] แทนที่ด้วย Webhook URL ของคุณ
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1427156086275838054/b1s0kKtOx9P7sSjqR53m3-QnYt5S6UVKVKOvR2LR9f-OvLgHBC7qSU-bwSjk9mgNUKAN";

// [สำคัญ!] แทนที่ด้วย ID Spreadsheet ที่คุณคัดลอกมา
const SPREADSHEET_ID = "YOUR_SPREADSHEET_ID_HERE"; 
const SHEET_NAME = "Sheet1"; // ชื่อแผ่นงาน (Sheet) ใน Spreadsheet

// -------------------------------------------------------------
// A. จัดการคำขอ POST (สำหรับบันทึกประวัติ และส่ง Discord Alert)
// -------------------------------------------------------------

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  
  if (data.action === "SAVE_HISTORY") {
    // 1. บันทึกประวัติลง Google Sheet
    saveHistory(data.payload);
    return ContentService.createTextOutput(JSON.stringify({ status: "history_saved" })).setMimeType(ContentService.MimeType.JSON);
  } 
  
  if (data.action === "DISCORD_ALERT") {
    // 2. ส่ง Discord Alert
    sendDiscordAlert(data.payload);
    return ContentService.createTextOutput(JSON.stringify({ status: "discord_sent" })).setMimeType(ContentService.MimeType.JSON);
  }
  
  return ContentService.createTextOutput(JSON.stringify({ status: "invalid_action" })).setMimeType(ContentService.MimeType.JSON);
}


function saveHistory(historyData) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);

  const rowData = [
    new Date(historyData.timestamp).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
    historyData.timeString,
    historyData.lat,
    historyData.lon,
    historyData.ip,
    historyData.address.province,
    historyData.address.district,
    historyData.address.road
  ];

  // เพิ่มข้อมูลที่บรรทัดบนสุด (2) เพื่อให้ประวัติใหม่ขึ้นก่อน
  sheet.insertRowBefore(2, rowData); 
  
  // จำกัดจำนวนแถวไม่ให้เกิน 20
  if (sheet.getLastRow() > 21) {
    sheet.deleteRows(21, sheet.getLastRow() - 21);
  }
}

function sendDiscordAlert(payload) {
  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload)
  };
  UrlFetchApp.fetch(DISCORD_WEBHOOK_URL, options);
}

// -------------------------------------------------------------
// B. จัดการคำขอ GET (สำหรับดึงประวัติมาแสดงในเว็บไซต์)
// -------------------------------------------------------------

function doGet(e) {
  if (e.parameter.action === "GET_HISTORY") {
    const history = getHistory();
    return ContentService.createTextOutput(JSON.stringify(history)).setMimeType(ContentService.MimeType.JSON);
  }
  return ContentService.createTextOutput(JSON.stringify({ status: "invalid_get_request" })).setMimeType(ContentService.MimeType.JSON);
}

function getHistory() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  
  // ดึงข้อมูล 20 แถวล่าสุด (เริ่มจากแถวที่ 2 ถึง 21)
  const range = sheet.getRange(2, 1, Math.min(sheet.getLastRow() - 1, 20), 8);
  const values = range.getValues();

  const history = values.map(row => ({
    timestamp: row[0],
    timeString: row[1],
    lat: row[2],
    lon: row[3],
    ip: row[4],
    address: {
        province: row[5],
        district: row[6],
        road: row[7]
    }
  }));

  return history;
}
