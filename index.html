<!DOCTYPE html>
<html>
<head>
    <title>Customer Ordering</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .menu-item { border: 1px solid #ddd; margin-bottom: 15px; padding: 15px; background-color: white; border-radius: 8px; }
        .menu-item h3 { margin-top: 0; color: #333; }
        .cart-item { margin-top: 5px; background-color: #e9e9e9; padding: 8px; border-radius: 4px; }
        #menuList { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #cart { margin-top: 20px; padding: 15px; border: 2px solid #007bff; border-radius: 8px; background-color: #fff; }
    </style>
</head>
<body>
    <h1>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÇ‡∏ï‡πä‡∏∞: <input type="text" id="tableNumber" value="A1" style="width: 50px;">)</h1>
    <div id="menuList"></div>

    <h2>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ üõí</h2>
    <div id="cart"></div>
    <button onclick="submitOrder()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    <p id="message" style="margin-top: 15px; font-weight: bold;"></p>

    <script>
        // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ socket ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const socket = io('http://localhost:3000'); 
        let cart = {}; 

        async function fetchMenu() {
            const response = await fetch('/api/menu');
            const data = await response.json();
            const menuList = document.getElementById('menuList');
            
            data.data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `
                    <h3>${item.name} (${item.price} ‡∏ö‡∏≤‡∏ó)</h3>
                    <p>${item.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}</p>
                    <input type="text" id="notes-${item.item_id}" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢, ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å‡∏ä‡∏µ)">
                    <button onclick="addToCart(${item.item_id}, '${item.name.replace(/'/g, "\\'")}', ${item.price})">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                `;
                menuList.appendChild(div);
            });
        }

        function addToCart(id, name, price) {
            if (!cart[id]) {
                cart[id] = { item_id: id, name, price, quantity: 0 };
            }
            cart[id].quantity++;
            // ‡∏î‡∏∂‡∏á notes ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
            cart[id].notes = document.getElementById(`notes-${id}`).value; 
            renderCart();
        }

        function renderCart() {
            const cartDiv = document.getElementById('cart');
            cartDiv.innerHTML = '';
            let total = 0;
            
            const cartItems = Object.values(cart).filter(item => item.quantity > 0);

            if (cartItems.length === 0) {
                cartDiv.innerHTML = '<p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
                return;
            }

            cartItems.forEach(item => {
                const itemTotal = item.quantity * item.price;
                total += itemTotal;
                const p = document.createElement('p');
                p.className = 'cart-item';
                p.innerHTML = `${item.name} x ${item.quantity} = ${itemTotal} ‡∏ö‡∏≤‡∏ó. 
                               ${item.notes ? `<br>(${item.notes})` : ''}`;
                cartDiv.appendChild(p);
            });
            cartDiv.innerHTML += `<h3>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ${total.toFixed(2)} ‡∏ö‡∏≤‡∏ó</h3>`;
        }
        
        async function submitOrder() {
            const table_number = document.getElementById('tableNumber').value;
            const items = Object.values(cart)
                .filter(item => item.quantity > 0)
                .map(item => ({ 
                    item_id: item.item_id, 
                    quantity: item.quantity, 
                    notes: item.notes 
                }));

            if (!table_number || items.length === 0) {
                document.getElementById('message').innerText = '‚ùå ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
                return;
            }

            document.getElementById('message').innerText = '...‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...';

            const response = await fetch('/api/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_number, items })
            });

            const result = await response.json();
            
            if (result.success) {
                document.getElementById('message').innerText = `‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Order ID: ${result.order_id}, ‡∏£‡∏ß‡∏° ${result.total_amount} ‡∏ö‡∏≤‡∏ó`;
                cart = {};
                renderCart();
            } else {
                document.getElementById('message').innerText = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.message}`;
            }
        }

        fetchMenu();
    </script>
</body>
</html>
