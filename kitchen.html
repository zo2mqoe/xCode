<!DOCTYPE html>
<html>
<head>
    <title>Kitchen Display System (KDS)</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #2c3e50; color: white; }
        h1 { color: #ecf0f1; }
        #ordersContainer { display: flex; flex-wrap: wrap; gap: 20px; }
        .order-card { 
            border-radius: 8px; padding: 15px; width: 320px; box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
            transition: transform 0.3s, opacity 0.5s;
        }
        .order-card h3 { margin-top: 0; }
        .pending { border: 3px solid #f39c12; background-color: #3e4c5e; }
        .in_progress { border: 3px solid #3498db; background-color: #3e4c5e; }
        .done { 
            border: 3px solid #2ecc71; 
            background-color: #1a242f; 
            opacity: 0.5; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏á‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß */
        }
        .order-card button { margin-right: 5px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .order-card button:nth-child(1) { background-color: #e67e22; } /* IN_PROGRESS */
        .order-card button:nth-child(2) { background-color: #27ae60; } /* DONE */
    </style>
</head>
<body>
    <h1>‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß (KDS) - ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>
    <div id="ordersContainer">
        </div>

    <script>
        const socket = io('http://localhost:3000');
        const ordersContainer = document.getElementById('ordersContainer');

        async function updateStatus(orderId, newStatus) {
            const response = await fetch('/api/order/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: orderId, status: newStatus })
            });
            const result = await response.json();
            if (!result.success) {
                alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.message}`);
            }
        }
        
        function renderOrderCard(order) {
            const cardId = `order-${order.order_id}`;
            let card = document.getElementById(cardId);
            if (!card) {
                card = document.createElement('div');
                card.id = cardId;
                ordersContainer.prepend(card); 
            }
            
            card.className = `order-card ${order.status.toLowerCase()}`;
            
            let itemsHtml = order.items.map(item => 
                `<li>${item.item_name} x ${item.quantity} 
                 ${item.notes ? `(${item.notes})` : ''}</li>`
            ).join('');

            card.innerHTML = `
                <h3>‡πÇ‡∏ï‡πä‡∏∞: ${order.table_number}</h3>
                <p style="font-size: small;">Order ID: ${order.order_id} | Time: ${order.order_time || 'N/A'}</p>
                <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <strong>${order.status}</strong></p>
                <ul>${itemsHtml}</ul>
                <button onclick="updateStatus(${order.order_id}, 'IN_PROGRESS')">üç¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</button>
                <button onclick="updateStatus(${order.order_id}, 'DONE')">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            `;
        }

        // 1. ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Socket.io
        socket.on('new_order', (order) => {
            console.log('New Order Received:', order);
            renderOrderCard(order); 
        });

        // 2. ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Socket.io
        socket.on('order_status_update', ({ order_id, status }) => {
            const card = document.getElementById(`order-${order_id}`);
            if (card) {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏µ Card ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                card.className = `order-card ${status.toLowerCase()}`;
                card.querySelector('strong').innerText = status;

                if (status === 'DONE') {
                    // ‡∏•‡∏ö Card ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    setTimeout(() => {
                        const doneCard = document.getElementById(`order-${order_id}`);
                        if (doneCard) doneCard.style.display = 'none';
                    }, 5000); 
                }
            }
        });
        
        // **(Optional)** ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PENDING/IN_PROGRESS ‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á)
        // fetchPendingOrders(); 
    </script>
</body>
</html>
